@page
@using OneShelf.Common
@using Economy.Memory.Tools
@model Economy.Web.Pages.Report1Model
@{
    ViewData["Title"] = "Report 1";
}

<form method="get">
    <div class="d-flex justify-content-start flex-wrap">
        <div class="form-group me-3">
            <label for="from">From</label>
            <input type="date" class="form-control" id="from" name="from" value="@Model.From?.ToString("yyyy-MM-dd")" />
        </div>
        <div class="form-group me-3">
            <label for="to">To</label>
            <input type="date" class="form-control" id="to" name="to" value="@Model.To?.ToString("yyyy-MM-dd")" />
        </div>
        <div class="form-group me-3">
            <label for="to">Funds plan ids</label>
            <input type="text" class="form-control" id="externalize" name="FundsPlanIds" value="@Model.FundsPlanIds" />
        </div>
        <div class="form-group">
            <label for="weekStart">Week Start</label>
            <select class="form-control" id="weekStart" name="weekStart">
                @foreach (var day in Enum.GetValues(typeof(DayOfWeek)).Cast<DayOfWeek>())
                {
                    <option value="@day" selected="@(day == Model.WeekStart)">@day</option>
                }
            </select>
        </div>
    </div>
    <button type="submit" class="btn btn-primary mt-2">View</button>
</form>

<div class="table-responsive table-fixed-header overflow-visible mt-4">
    <table class="table table-sm">
        <thead>
            <tr>
                <th>Date</th>
                <th>Incomes</th>
                <th>Expenses</th>
                @if (Model.FundsPlanIdsParsed != null)
                {
                    <th>
                        <div class="data-info">@Model.Funds.ToDetails()</div>
                        Funds
                    </th>
                }
                <th>Balance</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var (row, isFirst, isLast) in Model.Rows.WithIsFirstLast())
            {
                <tr class="@(row.Date.ToDateTime().DayOfWeek == Model.WeekStart ? "top-border" : null)">
                    <td class="text-nowrap">
                        @if (isFirst)
                        {
                            <span class="data-record">before</span>
                        }
                        else if (isLast)
                        {
                            <span class="data-record">after</span>
                        }
                        else
                        {
                            <span class="data-info">@row.Date.WithDayOfWeek()</span>
                            @foreach (var @event in row.Events)
                            {
                                <div class="data-record">@(@event.ToDetailsNoReferenceOrDate())</div>
                            }
                        }
                    </td>
                    <td class="data-record">
                        @foreach (var match in row.Incomes)
                        {
                            <div>
                                <partial name="_Report1Match" model="match" />
                            </div>
                        }
                    </td>
                    <td class="data-record">
                        @foreach (var match in row.Expenses)
                        {
                            <div>
                                <partial name="_Report1Match" model="match" />
                            </div>
                        }
                    </td>
                    @if (Model.FundsPlanIdsParsed != null)
                    {
                        <td class="data-record">
                            @foreach (var match in row.Funds)
                            {
                                <div>
                                    <partial name="_Report1Match" model="match" />
                                </div>
                            }
                        </td>
                    }
                    <td class="data-info text-nowrap">@row.Balance.ToDetails()</td>
                </tr>
            }
        </tbody>
    </table>
</div>