@page
@model ChatModel
@{
    ViewData["Title"] = "Chat";
}

<h2>Chat Application</h2>

<div id="connectionStatus">Status: <span id="statusText" class="disconnected">Disconnected</span></div>

<div id="chatsContainer"></div>

@section Scripts {
    <script>
        (() => {
            const connectionStatusText = document.getElementById('statusText');
            const chatsContainer = document.getElementById('chatsContainer');
            let connection;

            const initializeConnection = () => {
                try {
                    connection = new signalR.HubConnectionBuilder()
                        .withUrl("/chathub")
                        .withHubProtocol(new signalR.protocols.msgpack.MessagePackHubProtocol())
                        .withAutomaticReconnect({
                            nextRetryDelayInMilliseconds: retryContext => {
                                if (retryContext.elapsedMilliseconds < 60000) {
                                    return Math.random() * 3000;
                                } else {
                                    return null;
                                }
                            }
                        })
                        .configureLogging(signalR.LogLevel.Information)
                        .build();

                    // Event handlers
                    connection.onclose(error => {
                        handleConnectionClose(error);
                    });

                    connection.onreconnecting(error => {
                        handleConnectionReconnecting(error);
                    });

                    connection.onreconnected(connectionId => {
                        handleConnectionReconnected(connectionId);
                    });

                    connection.on('HelloResponse', state => {
                        handleHelloResponse(state);
                    });

                    connection.on('Authenticate', () => {
                        try {
                            location.reload();
                        } catch (err) {
                            console.error('Error in Authenticate handler:', err);
                        }
                    });

                    updateConnectionStatus('Reconnecting');
                    connection.start()
                        .then(() => {
                            updateConnectionStatus('Connected');
                            console.info('SignalR connection established.');
                            sendHello();
                        })
                        .catch(err => {
                            console.error('Connection error:', err.toString());
                        });
                } catch (err) {
                    console.error('Error initializing SignalR connection:', err);
                }
            };

            const handleConnectionClose = (error) => {
                updateConnectionStatus('Disconnected');
                disableInputs();
                logError('Connection closed', error);
            };

            const handleConnectionReconnecting = (error) => {
                updateConnectionStatus('Reconnecting');
                disableInputs();
                logError('Connection reconnecting', error);
            };

            const handleConnectionReconnected = (connectionId) => {
                updateConnectionStatus('Connected');
                sendHello();
                logInfo('Reconnected with connectionId:', connectionId);
            };

            const handleHelloResponse = (state) => {
                // Handle versioning or other properties if needed in the future
                // Initial render can be handled here if necessary
                renderChatView(state?.renderedChats);
            };

            const renderChatView = (renderedView) => {
                try {
                    // Store current input values and focused element
                    const inputValues = {};
                    const inputs = chatsContainer.querySelectorAll('input[type="text"]:not([disabled])');
                    let focusedElementId = document.activeElement.id;

                    inputs.forEach(input => {
                        inputValues[input.id] = input.value;
                    });

                    // Update the chat container
                    chatsContainer.innerHTML = renderedView;

                    // Restore input values
                    Object.keys(inputValues).forEach(id => {
                        const input = document.getElementById(id);
                        if (input) {
                            input.value = inputValues[id];
                        }
                    });

                    // Restore focus
                    if (focusedElementId) {
                        const focusedElement = document.getElementById(focusedElementId);
                        if (focusedElement) {
                            focusedElement.focus();
                        }
                    }
                } catch (err) {
                    console.error('Error rendering chat view:', err);
                    chatsContainer.innerHTML = '';
                }
            };

            const updateConnectionStatus = (status) => {
                connectionStatusText.textContent = status;
                const statusClass = status.toLowerCase();
                connectionStatusText.className = '';
                connectionStatusText.classList.add(statusClass);
            };

            const sendHello = () => {
                connection.invoke('Hello')
                    .catch(err => {
                        console.error('Error sending Hello:', err.toString());
                        handleHelloResponse(null);
                    });
            };

            const disableInputs = () => {
                const sendButtons = document.querySelectorAll('.sendButton.server-enabled');
                sendButtons.forEach(button => button.disabled = true);
            };

            const generateRandomId = () => {
                // Simple function to generate a random ID
                return 'id-' + Math.random().toString(36).substr(2, 9);
            };

            const tryCancelMessage = (chatId, messageId) => {
                connection.invoke('TryCancel', chatId, messageId)
                    .catch(err => {
                        console.error('TryCancel error:', err.toString());
                    });
            };

            const sendMessage = (chatId) => {
                const messageInput = document.getElementById('messageInput-' + chatId);
                const sendButton = document.getElementById('sendButton-' + chatId);
                messageInput.disabled = true;
                sendButton.disabled = true;

                connection.invoke('SendMessage', chatId, generateRandomId(), messageInput.value)
                    .catch(err => {
                        console.error('Error sending message:', err.toString());
                    });
            };

            const closeChat = (chatId) => {
                const chat = document.getElementById('chat-' + chatId);
                chat.remove();
                connection.invoke('CloseChat', chatId)
                    .catch(err => {
                        console.error('Error closing chat:', err.toString());
                    });
            };

            window.chatsComponent = {
                tryCancelMessage: tryCancelMessage,
                sendMessage: sendMessage,
                closeChat: closeChat
            };

            const logError = (message, error) => {
                console.error(message, error);
            };

            const logInfo = (message, info) => {
                console.info(message, info);
            };

            // Initialize the connection
            initializeConnection();
        })();
    </script>
}
<style>
    .chat {
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 20px;
        border-radius: 5px;
    }

        .chat h3 {
            margin-top: 0;
        }

    .messageInput {
        width: 70%;
        padding: 5px;
    }

    .sendButton {
        margin-left: 5px;
        padding: 5px 10px;
    }

    #connectionStatus {
        font-weight: bold;
        margin-bottom: 10px;
    }

        #connectionStatus span {
            color: red;
        }

            #connectionStatus span.connected {
                color: green;
            }

            #connectionStatus span.reconnecting {
                color: orange;
            }

    .system-message {
        color: gray;
        font-style: italic;
    }

    .own-message {
        color: blue;
    }
</style>
